# name: Checkmarx One Scan
# on:
#   push:
#     branches:
#       - main
#       - master
#       - dev
# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
#       - name: Checkmarx One CLI Action
#         uses: checkmarx/ast-github-action@main #Github Action version
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/ 
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}

##########
# name: Checkmarx ‚Üí GitHub Code Scanning

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# permissions:
#   contents: read
#   actions: read
#   security-events: write   # ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î SARIF

# jobs:
#   checkmarx:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       # 1) ‡∏£‡∏±‡∏ô Checkmarx One ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå SARIF
#       - name: Checkmarx One CLI
#         uses: checkmarx/ast-github-action@main
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           # ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á CLI ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô SARIF ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ cx_result.sarif ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏ó‡∏Ç‡∏≠‡∏á workspace
#           additional_params: >-
#             --report-format sarif
#             --output-path .
#             --output-name cx_result

#       # 2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå SARIF ‡πÑ‡∏õ‡∏ó‡∏µ‡πà GitHub Code Scanning
#       - name: Upload SARIF to Code Scanning
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: cx_result.sarif

#       # 3) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå SARIF ‡πÄ‡∏õ‡πá‡∏ô Artifact (‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ)
#       - name: Upload Checkmarx SARIF (artifact)
#         if: ${{ always() && hashFiles('cx_result.sarif') != '' }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: SARIF-Checkmarx
#           path: cx_result.sarif
#           retention-days: 30


##############
# name: Checkmarx ‚Üí GitHub Code Scanning + SBOM (CycloneDX & SPDX)

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# permissions:
#   contents: read
#   actions: read
#   security-events: write   # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î SARIF ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Code scanning

# jobs:
#   checkmarx:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       # 1) ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á SARIF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Code Scanning
#       - name: Checkmarx One CLI (SARIF)
#         uses: checkmarx/ast-github-action@main
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           additional_params: >-
#             --report-format sarif
#             --output-path .
#             --output-name cx_result

#       - name: Upload SARIF to Code Scanning
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: cx_result.sarif

#       - name: Upload Checkmarx SARIF (artifact)
#         if: ${{ always() && hashFiles('cx_result.sarif') != '' }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: SARIF-Checkmarx
#           path: cx_result.sarif
#           retention-days: 30

#   # 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á SBOM ‡∏™‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏î‡πâ‡∏ß‡∏¢ matrix: CycloneDxJson ‡πÅ‡∏•‡∏∞ SpdxJson
#   sbom:
#     needs: checkmarx
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         fmt: [ CycloneDxJson, SpdxJson ]
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Checkmarx One CLI (SBOM - ${{ matrix.fmt }})
#         uses: checkmarx/ast-github-action@main
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           additional_params: >-
#             --report-format sbom
#             --report-sbom-format ${{ matrix.fmt }}
#             --output-path .
#             --output-name sbom-${{ matrix.fmt }}

#       - name: Upload SBOM (artifact) - ${{ matrix.fmt }}
#         if: ${{ always() && hashFiles(format('sbom-{0}.json', matrix.fmt)) != '' }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: SBOM-${{ matrix.fmt }}
#           path: sbom-${{ matrix.fmt }}.json
#           retention-days: 30

############
# name: Checkmarx ‚Üí Code Scanning + SBOM

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# permissions:
#   contents: read
#   actions: read
#   security-events: write

# jobs:
#   checkmarx:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       # 1) ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á SARIF
#       - name: Checkmarx One CLI (SARIF)
#         uses: checkmarx/ast-github-action@main
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           additional_params: >-
#             --scan-types sca
#             --report-format sarif
#             --output-path $GITHUB_WORKSPACE
#             --output-name cx_result

#       - name: Post Upload SARIF to Code Scanning
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: cx_result.sarif

#       # 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á SBOM: CycloneDX JSON
#       - name: SBOM (CycloneDX JSON)
#         uses: checkmarx/ast-github-action@main
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           additional_params: >-
#             --scan-types sca
#             --report-format sbom
#             --report-sbom-format CycloneDxJson
#             --output-path $GITHUB_WORKSPACE
#             --output-name sbom-cyclonedx

#       # 3) ‡∏™‡∏£‡πâ‡∏≤‡∏á SBOM: SPDX JSON
#       - name: SBOM (SPDX JSON)
#         uses: checkmarx/ast-github-action@main
#         with:
#           project_name: fluk-test
#           cx_tenant: nfr-fusionadvantec-sg
#           base_uri: https://sng.ast.checkmarx.net/
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           additional_params: >-
#             --scan-types sca
#             --report-format sbom
#             --report-sbom-format SpdxJson
#             --output-path $GITHUB_WORKSPACE
#             --output-name sbom-spdx

#       # 4) ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏µ‡∏ö‡∏±‡πä‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏û‡∏≤‡∏ò)
#       - name: List generated files
#         run: |
#           echo "PWD: $(pwd)"
#           ls -la
#           echo "---- find sbom files ----"
#           find . -maxdepth 2 -type f -name "sbom-*" -o -name "cx_result.*" -print

#       # 5) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Artifact (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ hashFiles, ‡πÉ‡∏ä‡πâ always + wildcard)
#       # - name: Upload SBOM & SARIF Artifacts
#       #   if: ${{ always() }}
#       #   uses: actions/upload-artifact@v4
#       #   with:
#       #     name: Checkmarx-Reports
#       #     path: |
#       #       cx_result.sarif
#       #       sbom-cyclonedx.json
#       #       sbom-spdx.json
#       #     retention-days: 30
#       - name: Upload SBOM & SARIF Artifacts
#         if: ${{ always() }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: Checkmarx-Reports
#           path: |
#             cx_result.sarif
#             sbom-*_sbom.json
#           retention-days: 30


name: Checkmarx ‚Üí Code Scanning + SBOM via API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  checkmarx:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) ‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Checkmarx One (‡∏™‡∏£‡πâ‡∏≤‡∏á SARIF)
      - name: Checkmarx One CLI (SARIF)
        uses: checkmarx/ast-github-action@main
        with:
          project_name: fluk-test
          cx_tenant: nfr-fusionadvantec-sg
          base_uri: https://sng.ast.checkmarx.net/
          cx_client_id: ${{ secrets.CX_CLIENT_ID }}
          cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
          additional_params: >-
            --scan-types sca
            --report-format sarif
            --output-path $GITHUB_WORKSPACE
            --output-name cx_result

      # 2) Upload SARIF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô GitHub Code Scanning
      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: cx_result.sarif

      # 3) ‡πÉ‡∏ä‡πâ curl ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏´‡∏≤ Scan ID ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Project/Branch
      - name: Get latest Scan ID from Checkmarx API
        id: get_scan_id
        env:
          CX_BASE_URI: https://sng.ast.checkmarx.net
          CX_TENANT: nfr-fusionadvantec-sg
          CX_CLIENT_ID: ${{ secrets.CX_CLIENT_ID }}
          CX_CLIENT_SECRET: ${{ secrets.CX_CLIENT_SECRET }}
          PROJECT: fluk-test
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          echo "üîê Getting access token..."
          TOKEN=$(curl -s -X POST "$CX_BASE_URI/identity/connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=$CX_CLIENT_ID" \
            -d "client_secret=$CX_CLIENT_SECRET" \
            -d "scope=api_access" | jq -r '.access_token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "::error::Failed to get OAuth token"
            exit 1
          fi

          echo "‚úÖ Got access token"
          echo "üîç Fetching latest scan for project '$PROJECT' (branch: $BRANCH)..."

          SCAN_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "$CX_BASE_URI/api/scans?projectName=$PROJECT&branch=$BRANCH&limit=1" | jq -r '.[0].id // empty')

          if [ -z "$SCAN_ID" ]; then
            echo "::error::No scan found for $PROJECT ($BRANCH)"
            exit 1
          fi

          echo "‚úÖ Found Scan ID: $SCAN_ID"
          echo "scan_id=$SCAN_ID" >> $GITHUB_OUTPUT

      # 4) ‡πÉ‡∏ä‡πâ API ‡∏™‡∏£‡πâ‡∏≤‡∏á SBOM CycloneDX
      - name: Generate CycloneDX SBOM via API
        env:
          CX_BASE_URI: https://sng.ast.checkmarx.net
          CX_CLIENT_ID: ${{ secrets.CX_CLIENT_ID }}
          CX_CLIENT_SECRET: ${{ secrets.CX_CLIENT_SECRET }}
          SCAN_ID: ${{ steps.get_scan_id.outputs.scan_id }}
        run: |
          set -euo pipefail

          echo "üîê Getting access token..."
          TOKEN=$(curl -s -X POST "$CX_BASE_URI/identity/connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=$CX_CLIENT_ID" \
            -d "client_secret=$CX_CLIENT_SECRET" \
            -d "scope=api_access" | jq -r '.access_token')

          echo "üì¶ Requesting CycloneDX SBOM..."
          REPORT_ID=$(curl -s -X POST "$CX_BASE_URI/api/reports" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"scanId\": \"$SCAN_ID\",
              \"type\": \"SBOM\",
              \"format\": \"CycloneDxJson\"
            }" | jq -r '.reportId')

          echo "CycloneDX Report ID: $REPORT_ID"
          echo "‚è≥ Waiting for report..."
          for i in {1..20}; do
            STATUS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "$CX_BASE_URI/api/reports/$REPORT_ID" | jq -r '.status')
            echo "Status: $STATUS"
            if [ "$STATUS" = "Completed" ]; then break; fi
            sleep 10
          done

          curl -s -H "Authorization: Bearer $TOKEN" \
            -o sbom-cyclonedx.json \
            "$CX_BASE_URI/api/reports/$REPORT_ID/download"

          echo "‚úÖ CycloneDX SBOM downloaded (sbom-cyclonedx.json)"

      # 5) ‡πÉ‡∏ä‡πâ API ‡∏™‡∏£‡πâ‡∏≤‡∏á SBOM SPDX
      - name: Generate SPDX SBOM via API
        env:
          CX_BASE_URI: https://sng.ast.checkmarx.net
          CX_CLIENT_ID: ${{ secrets.CX_CLIENT_ID }}
          CX_CLIENT_SECRET: ${{ secrets.CX_CLIENT_SECRET }}
          SCAN_ID: ${{ steps.get_scan_id.outputs.scan_id }}
        run: |
          set -euo pipefail

          echo "üîê Getting access token..."
          TOKEN=$(curl -s -X POST "$CX_BASE_URI/identity/connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=$CX_CLIENT_ID" \
            -d "client_secret=$CX_CLIENT_SECRET" \
            -d "scope=api_access" | jq -r '.access_token')

          echo "üì¶ Requesting SPDX SBOM..."
          REPORT_ID=$(curl -s -X POST "$CX_BASE_URI/api/reports" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"scanId\": \"$SCAN_ID\",
              \"type\": \"SBOM\",
              \"format\": \"SpdxJson\"
            }" | jq -r '.reportId')

          echo "SPDX Report ID: $REPORT_ID"
          echo "‚è≥ Waiting for report..."
          for i in {1..20}; do
            STATUS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "$CX_BASE_URI/api/reports/$REPORT_ID" | jq -r '.status')
            echo "Status: $STATUS"
            if [ "$STATUS" = "Completed" ]; then break; fi
            sleep 10
          done

          curl -s -H "Authorization: Bearer $TOKEN" \
            -o sbom-spdx.json \
            "$CX_BASE_URI/api/reports/$REPORT_ID/download"

          echo "‚úÖ SPDX SBOM downloaded (sbom-spdx.json)"

      # 6) ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      - name: List generated files
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "---- find SBOM & SARIF files ----"
          find . -maxdepth 2 -type f -name "*.json" -o -name "*.sarif" -print

      # 7) Upload ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Artifact
      - name: Upload Reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: Checkmarx-Reports
          path: |
            cx_result.sarif
            sbom-cyclonedx.json
            sbom-spdx.json
          retention-days: 30

