name: Checkmarx Container Scan - sorakith/nginx-private

# on:
#   workflow_dispatch:
#   push:
#     branches: [ "main" ]

# jobs:
#   scan:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       security-events: write   # อัปโหลด SARIF ไป GitHub Security

#     env:
#       # ตั้งค่า registry & credential สำหรับ Docker Hub (private)
#       REGISTRIES: "docker.io"
#       USERNAME_DOCKER_IO: ${{ secrets.DOCKERHUB_USERNAME }}
#       PASSWORD_DOCKER_IO: ${{ secrets.DOCKERHUB_TOKEN }}
#       # อิมเมจที่จะสแกน (ชี้ไปที่ repo ที่ให้มา)
#       IMAGE_NAME: "sorakith/vulner-image"
#       IMAGE_TAG:  "v1"

#     steps:
#       - name: Checkout (optional)
#         uses: actions/checkout@v4

#       - name: Docker login & pre-pull (optional sanity check)
#         run: |
#           echo "${PASSWORD_DOCKER_IO}" | docker login -u "${USERNAME_DOCKER_IO}" --password-stdin docker.io
#           docker pull "${IMAGE_NAME}:${IMAGE_TAG}"

#       - name: Run Checkmarx One (Container Security)
#         uses: Checkmarx/ast-github-action@2.3.27
#         with:
#           base_uri: https://sng.ast.checkmarx.net/     # เช่น https://sng.ast.checkmarx.net
#           cx_tenant: nfr-fusionadvantec-sg
#           cx_client_id: ${{ secrets.CX_CLIENT_ID }}
#           cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
#           project_name: max17245/Assignment
#           branch: ${{ github.ref_name }}
#           additional_params: >
#             --scan-types container-security
#             # --containers-local-resolution
#             --container-images "${IMAGE_NAME}:${IMAGE_TAG}"
#             --report-format sarif
#             --output-path .
#             --output-name cx_result
            
#         env:
#           # ส่ง env สำหรับรีจิสทรีเข้าไปให้ตัว action ใช้งาน
#           REGISTRIES: ${{ env.REGISTRIES }}
#           USERNAME_DOCKER_IO: ${{ env.USERNAME_DOCKER_IO }}
#           PASSWORD_DOCKER_IO: ${{ env.PASSWORD_DOCKER_IO }}

#       - name: Upload SARIF to GitHub Security
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: cx_result.sarif



# Controls when the workflow will run
on:
  workflow_dispatch:

permissions:
  contents: read

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif

    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job

    steps:
      - name :  Checkout repository
        uses: actions/checkout@v4

      - name: Checkmarx One scan
        uses: Checkmarx/ast-github-action@427623bbb54f318e690463e11302a1eb1b9b2b5a
        env:
          REGISTRIES: "docker.io ghcr.io mycompany.jfrog.io"
          USERNAME_DOCKER_IO: ${{ secrets.DOCKER_USERNAME }}
          PASSWORD_DOCKER_IO: ${{ secrets.DOCKERHUB_TOKEN }}
          # USERNAME_GHCR_IO: ${{ secrets.GHCR_USERNAME }}
          # PASSWORD_GHCR_IO: ${{ secrets.GHCR_TOKEN }}
          # USERNAME_MYCOMPANY_JFROG_IO: ${{ secrets.JFROG_USERNAME }}
          # PASSWORD_MYCOMPANY_JFROG_IO: ${{ secrets.JFROG_ACCESS_TOKEN }}
        with:
          base_uri: https://sng.ast.checkmarx.net/  # This should be replaced by your base uri for Checkmarx One
          cx_client_id: ${{ secrets.CX_CLIENT_ID }} # This should be created within your Checkmarx One account : https://checkmarx.com/resource/documents/en/34965-118315-authentication-for-checkmarx-one-cli.html#UUID-a4e31a96-1f36-6293-e95a-97b4b9189060_UUID-4123a2ff-32d0-2287-8dd2-3c36947f675e
          cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }} # This should be created within your Checkmarx One account : https://checkmarx.com/resource/documents/en/34965-118315-authentication-for-checkmarx-one-cli.html#UUID-a4e31a96-1f36-6293-e95a-97b4b9189060_UUID-4123a2ff-32d0-2287-8dd2-3c36947f675e
          cx_tenant: nfr-fusionadvantec-sg # This should be replaced by your tenant for Checkmarx One
          additional_params: >
            --scan-types container-security 
            --container-images "sorakith/vulner-image:v1"
            
      # - name: Upload SARIF file
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #      # Path to SARIF file relative to the root of the repository
      #     sarif_file: cx_result.sarif
